{% extends "base.html" %}
{% block content %}

<!-- HERO -->
<div class="hero">

  <div class="hero-card">
    <h1>Pesquisas brasileiras, em linguagem clara.</h1>

    <p class="muted">
      PublicaÃ§Ãµes curtas, citÃ¡veis e com fonte original.
      CiÃªncia acessÃ­vel, sem perder o rigor.
    </p>

    <!-- BUSCA + FILTRO -->
    <form action="{{ url_for('index') }}" method="get" class="search-bar" id="areaForm">
      <input
        type="text"
        name="q"
        value="{{ q or '' }}"
        placeholder="Buscar por tema, autor(a) ou tÃ­tuloâ€¦"
        aria-label="Buscar pesquisas"
        style="flex: 1;"
      >

      <select name="area" id="areaSelect" aria-label="Filtrar por Ã¡rea" style="min-width: 210px;">
        <option value="">Todas as Ã¡reas</option>
        {% for a in areas %}
          <option value="{{ a }}" {% if filtro_area == a %}selected{% endif %}>
            {{ a }}
          </option>
        {% endfor %}
      </select>

      <button type="submit" class="btn">Buscar</button>
    </form>

    <div class="filters-area">
      <span class="muted" style="font-size: .85rem; font-weight:700;">Populares:</span>

      <a href="{{ url_for('index', area='SaÃºde') }}" class="chip">SaÃºde</a>
      <a href="{{ url_for('index', area='Tecnologia') }}" class="chip">Tecnologia</a>

      <a href="{{ url_for('index') }}" class="chip" style="background:#fff;">Limpar</a>
    </div>

    {% if q %}
      <div class="muted" style="margin-top: 10px; font-size: .92rem;">
        Resultados para: <b>{{ q }}</b>
      </div>
    {% endif %}
  </div>


  <!-- REGRA DE OURO -->
  <div class="callout">
    <div class="callout-icon">ğŸ’¡</div>

    <div>
      <span class="callout-title">A regra de ouro</span>

      <p style="margin:0;">
        Compartilhe sua descoberta de uma forma <b> simples </b>.
      </p>

      <p class="muted" style="margin-top:8px;">
        Pense em 3 partes:
        <b>o que Ã©</b> â€¢ <b>por que importa</b> â€¢ <b>o que muda</b>
      </p>
    </div>
  </div>

</div>


<!-- GRID -->
<section class="grid">

{% if not pesquisas %}
  <!-- EMPTY STATE PREMIUM -->
  <div class="card" style="grid-column: 1 / -1; text-align:center; padding: 50px;">
    <div style="font-size:52px;">ğŸŒ±</div>

    <h2 style="margin-top:10px;">
      Ainda nÃ£o hÃ¡ pesquisas{% if filtro_area %} em <b>{{ filtro_area }}</b>{% endif %}{% if q %} para <b>{{ q }}</b>{% endif %}.
    </h2>

    <p class="muted">
      O IpÃª comeÃ§a com quem publica. Seja a primeira voz cientÃ­fica aqui.
    </p>

    {% if current_user.is_authenticated %}
      <a class="btn" href="{{ url_for('publicar') }}">Publicar pesquisa</a>
    {% else %}
      <a class="btn" href="{{ url_for('register') }}">Criar conta gratuita</a>

      <p class="muted" style="margin-top:10px;">
        JÃ¡ possui conta?
        <a href="{{ url_for('login') }}" style="font-weight:800;">Entrar</a>
      </p>
    {% endif %}
  </div>
{% endif %}


{% for p in pesquisas %}

<article class="card card-click">

  <!-- Card inteiro clicÃ¡vel -->
  <a href="{{ url_for('pesquisa', pid=p['id']) }}" class="card-overlay" aria-label="Abrir pesquisa"></a>

  <div class="card-header">
    <span class="badge-area">{{ p["area"] }}</span>
    <span class="badge-evidencia {{ p['evidencia']|lower }}">{{ p["evidencia"] }}</span>
  </div>

  <h2 class="card-title">{{ p["titulo"] }}</h2>

  {% if p["imagem_url"] %}
    <img
      src="{{ p['imagem_url'] }}"
      class="card-img"
      loading="lazy"
      alt="Imagem da pesquisa"
    >
  {% endif %}

  <p>
    <b>O que Ã©:</b>
    <span class="muted">
      {{ p["descoberta"][:220] }}
      {% if p["descoberta"]|length > 220 %}...{% endif %}
    </span>
  </p>

  <!-- MÃ©tricas -->
  <div class="muted" style="display:flex; gap: 12px; flex-wrap:wrap; margin-top: 10px; font-size: .9rem;">
    <span>ğŸ‘ï¸ {{ p.get("views", 0) }}</span>
    <span>â¤ï¸ {{ p.get("likes_count", 0) }}</span>
    <span>ğŸ”– {{ p.get("saves_count", 0) }}</span>
  </div>

  <div class="actions" style="position: relative; z-index: 2;">

    <a href="{{ url_for('perfil', nome=p['pesquisador']) }}"
       class="btn-perfil"
       onclick="event.stopPropagation();">
       ğŸ‘©â€ğŸ”¬ {{ p["pesquisador"] }}
    </a>

    <div style="display:flex; gap:10px; align-items:center;">
      <!-- Curtir / Salvar (sÃ³ logado) -->
      {% if current_user.is_authenticated %}
        <form method="POST" action="{{ url_for('toggle_like', pid=p['id']) }}" style="display:inline;">
          <button type="submit" class="btn ghost" style="padding: 8px 12px;"
                  onclick="event.stopPropagation();">
            â¤ï¸
          </button>
        </form>

        <form method="POST" action="{{ url_for('toggle_save', pid=p['id']) }}" style="display:inline;">
          <button type="submit" class="btn ghost" style="padding: 8px 12px;"
                  onclick="event.stopPropagation();">
            ğŸ”–
          </button>
        </form>
      {% endif %}

      <!-- Link original robusto -->
      {% set link = (p['link_original'] or '').strip() %}
      {% if link %}
        {% if link.lower().startswith('http://') or link.lower().startswith('https://') %}
          <a href="{{ link }}" target="_blank" rel="noopener noreferrer" class="btn-link"
             onclick="event.stopPropagation();">ğŸ“„ Ver original</a>
        {% elif link.lower().startswith('doi.org/') %}
          <a href="https://{{ link }}" target="_blank" rel="noopener noreferrer" class="btn-link"
             onclick="event.stopPropagation();">ğŸ“„ Ver original</a>
        {% elif link.startswith('10.') %}
          <a href="https://doi.org/{{ link }}" target="_blank" rel="noopener noreferrer" class="btn-link"
             onclick="event.stopPropagation();">ğŸ“„ Ver original</a>
        {% else %}
          <a href="https://{{ link }}" target="_blank" rel="noopener noreferrer" class="btn-link"
             onclick="event.stopPropagation();">ğŸ“„ Ver original</a>
        {% endif %}
      {% endif %}
    </div>

  </div>

</article>

{% endfor %}

</section>


<!-- AUTO SUBMIT DO SELECT (mantÃ©m) -->
<script>
(function(){
  const sel = document.getElementById("areaSelect");
  const form = document.getElementById("areaForm");
  if(sel && form){
    sel.addEventListener("change", () => form.submit());
  }
})();
</script>

{% endblock %}
